apiVersion: batch/v1
kind: Job
metadata:
  name: create-gitlab-db
  namespace: postgresql
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: db-creator
          # Use the same postgres version as your DB
          image: postgres:16
          env:
            # 1. Connect to the Read-Write Service created by CNPG
            - name: DB_HOST
              value: "cluster-database-rw.postgresql.svc.cluster.local"
            
            # 2. Use the SUPERUSER credentials (auto-generated by the operator)
            # This is much more reliable for admin tasks than the app user.
            - name: DB_USER
              value: "postgres"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  # This matches the 'secretName' you set in your values.yaml
                  name: cluster-superuser
                  key: password
            
            # 3. Define the new user/pass for GitLab
            - name: NEW_USER
              value: "gitlab_admin"
            - name: NEW_DB
              value: "gitlab"
            - name: NEW_USER_PASS
              value: "unique_password_goes_here" # Change this!

          command:
            - sh
            - -c
            - |
              echo "1. Waiting for CNPG Primary to be ready..."
              # We check connection using the superuser
              until pg_isready -h $DB_HOST -U $DB_USER; do 
                echo "Waiting for DB..."
                sleep 2
              done

              echo "2. Creating User and Database..."
              # Connect to the 'postgres' database as 'postgres' superuser
              
              psql -h $DB_HOST -U $DB_USER -d postgres -v ON_ERROR_STOP=1 <<EOF
                -- Create the user (if not exists)
                DO \$\$
                BEGIN
                  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$NEW_USER') THEN
                    CREATE USER $NEW_USER WITH PASSWORD '$NEW_USER_PASS';
                  END IF;
                END
                \$\$;

                -- Create the database
                SELECT 'CREATE DATABASE $NEW_DB OWNER $NEW_USER'
                WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '$NEW_DB')\gexec
              EOF

              echo "3. Success! Database '$NEW_DB' created."